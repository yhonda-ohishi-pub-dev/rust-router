stages:
  - lint
  - test
  - publish

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  RUSTUP_HOME: ${CI_PROJECT_DIR}/.rustup

# Cache cargo dependencies
.cache-template: &cache-template
  cache:
    key: ${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}
    paths:
      - .cargo/
      - target/

# Rust image
.rust-template: &rust-template
  image: rust:1.75
  <<: *cache-template
  before_script:
    - rustup component add clippy rustfmt

# Lint stage
lint:format:
  <<: *rust-template
  stage: lint
  script:
    - cargo fmt -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

lint:clippy:
  <<: *rust-template
  stage: lint
  script:
    - cargo clippy --workspace -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Test stage
test:auth:
  <<: *rust-template
  stage: test
  script:
    - cargo test -p auth --all-features
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:db:
  <<: *rust-template
  stage: test
  script:
    - cargo test -p db --all-features
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:error:
  <<: *rust-template
  stage: test
  script:
    - cargo test -p error --all-features
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Publish stage - create git tag for versioning
publish:tag:
  stage: publish
  image: alpine:latest
  script:
    - echo "Tag created - shared-lib version ${CI_COMMIT_TAG}"
    - echo "Other services can now reference this tag in their Cargo.toml"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/
